define(["jquery","block_myoverview/repository","core/paged_content_factory","core/custom_interaction_events","core/notification","core/ajax","core/templates"],function(a,b,c,d,e,f,g){var h={COURSE_REGION:'[data-region="course-view-content"]',ACTION_HIDE_COURSE:'[data-action="hide-course"]',ACTION_SHOW_COURSE:'[data-action="show-course"]',ACTION_ADD_FAVOURITE:'[data-action="add-favourite"]',ACTION_REMOVE_FAVOURITE:'[data-action="remove-favourite"]',FAVOURITE_ICON:'[data-region="favourite-icon"]',ICON_IS_FAVOURITE:'[data-region="is-favourite"]',ICON_NOT_FAVOURITE:'[data-region="not-favourite"]',PAGED_CONTENT_CONTAINER:'[data-region="page-container"]'},i={COURSES_CARDS:"block_myoverview/view-cards",COURSES_LIST:"block_myoverview/view-list",COURSES_SUMMARY:"block_myoverview/view-summary",NOCOURSES:"block_myoverview/no-courses"},j=[12,24,48],k=[],l=function(a){var b={};return b.display=a.attr("data-display"),b.prevDisplay=a.attr("data-prev-display"),b.grouping=a.attr("data-grouping"),b.sort=a.attr("data-sort"),b},m={ignoreControlWhileLoading:!0,controlPlacementBottom:!0},n=function(c,d,e,f){if(d.display!=d.prevDisplay){c.attr("data-prev-display",d.display);var g=new a.Deferred;return g.resolve(k),g.promise()}return b.getEnrolledCoursesByTimeline({offset:f*e,limit:e,classification:d.grouping,sort:d.sort})},o=function(a,b){return a.find(h.FAVOURITE_ICON+'[data-course-id="'+b+'"]')},p=function(a){return a.attr("data-course-id")},q=function(a,b){var c=o(a,b),d=c.find(h.ICON_IS_FAVOURITE);d.addClass("hidden"),d.attr("aria-hidden",!0);var e=c.find(h.ICON_NOT_FAVOURITE);e.removeClass("hidden"),e.attr("aria-hidden",!1)},r=function(a,b){var c=o(a,b),d=c.find(h.ICON_IS_FAVOURITE);d.removeClass("hidden"),d.attr("aria-hidden",!1);var e=c.find(h.ICON_NOT_FAVOURITE);e.addClass("hidden"),e.attr("aria-hidden",!0)},s=function(a,b){return a.find('[data-action="add-favourite"][data-course-id="'+b+'"]')},t=function(a,b){return a.find('[data-action="remove-favourite"][data-course-id="'+b+'"]')},u=function(a,b){var c=t(a,b),d=s(a,b);w(b,!0).then(function(f){f?(c.removeClass("hidden"),d.addClass("hidden"),r(a,b)):e.alert("Starring course failed","Could not change favourite state")})["catch"](e.exception)},v=function(a,b){var c=t(a,b),d=s(a,b);w(b,!1).then(function(f){f?(c.addClass("hidden"),d.removeClass("hidden"),q(a,b)):e.alert("Starring course failed","Could not change favourite state")})["catch"](e.exception)},w=function(a,c){return b.setFavouriteCourses({courses:[{id:a,favourite:c}]}).then(function(b){return 0==b.warnings.length&&(k.courses.forEach(function(b,d){b.id==a&&(k.courses[d].isfavourite=c)}),!0)})["catch"](e.exception)},x=function(a,b,c){var d="";if(d="cards"==c.display?i.COURSES_CARDS:"list"==c.display?i.COURSES_LIST:i.COURSES_SUMMARY,b.courses.length)return g.render(d,{courses:b.courses});var e=a.attr("data-nocoursesimg");return g.render(i.NOCOURSES,{nocoursesimg:e})},y=function(a,b){var d=l(a),f=c.createWithLimit(j,function(b,c){var f=[];return b.forEach(function(b){var g=b.pageNumber-1,h=n(a,d,b.limit,g).then(function(e){return e.courses.length<b.limit&&c.allItemsLoaded(b.pageNumber),k=e,x(a,e,d)})["catch"](e.exception);f.push(h)}),f},m);f.then(function(a,c){return g.replaceNodeContents(b,a,c)})["catch"](e.exception)},z=function(c,e){d.define(c,[d.events.activate]),c.on(d.events.activate,h.ACTION_ADD_FAVOURITE,function(b,d){var e=a(b.target).closest(h.ACTION_ADD_FAVOURITE),f=p(e);u(c,f),d.originalEvent.preventDefault()}),c.on(d.events.activate,h.ACTION_REMOVE_FAVOURITE,function(b,d){var e=a(b.target).closest(h.ACTION_REMOVE_FAVOURITE),f=p(e);v(c,f),d.originalEvent.preventDefault()}),c.on(d.events.activate,h.FAVOURITE_ICON,function(a,b){b.originalEvent.preventDefault()}),c.on(d.events.activate,h.ACTION_HIDE_COURSE,function(d,f){var g=a(d.target).closest(h.ACTION_HIDE_COURSE),i=p(g),j={preferences:[{type:"block_myoverview_hidden_course_"+i,value:!0}]};b.updateUserPreferences(j),y(c,e),f.originalEvent.preventDefault()}),c.on(d.events.activate,h.ACTION_SHOW_COURSE,function(d,f){var g=a(d.target).closest(h.ACTION_SHOW_COURSE),i=p(g),j={preferences:[{type:"block_myoverview_hidden_course_"+i,value:null}]};b.updateUserPreferences(j),y(c,e),f.originalEvent.preventDefault()})},A=function(b,c){b=a(b),b.attr("data-init")||(z(b,c),b.attr("data-init",!0)),y(b,c)},B=function(a,b){A(a,b)};return{init:A,reset:B}});