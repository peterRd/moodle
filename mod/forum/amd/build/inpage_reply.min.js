define(["jquery","core/templates","core/notification","mod_forum/repository","mod_forum/selectors"],function(a,b,c,d,e){var f={THREADED:2,NESTED:3,FLAT_OLDEST_FIRST:1,FLAT_NEWEST_FIRST:-1},g=function(g){g.on("click",e.post.inpage_submit_btn,function(h){h.preventDefault();var i=a(h.currentTarget).parents(e.post.inpage_reply_form).get(0),j=i.elements.post.value,k=i.elements.reply.value,l=i.elements.subject.value,m=a(h.currentTarget).parents(e.post.forum_content),n=parseInt(g.find(e.post.mode_select).get(0).value);d.addDiscussionPost(k,l,j).then(function(a){var c=a.post;switch(n){case f.THREADED:return b.render("mod_forum/forum_discussion_threaded_post",c);case f.NESTED:return b.render("mod_forum/forum_discussion_nested_post",c);default:return b.render("mod_forum/forum_discussion_post",c)}}).then(function(a,c){var d;return d=n==f.FLAT_OLDEST_FIRST||n==f.FLAT_NEWEST_FIRST?m.parents(e.post.replies_container).children().get(0):m.siblings(e.post.replies_container).children().get(0),n==f.FLAT_NEWEST_FIRST?b.prependNodeContents(d,a,c):b.appendNodeContents(d,a,c)}).then(function(){return m.find(e.post.inpage_reply_content).hide()}).fail(c.exception)})};return{init:function(a){g(a)}}});